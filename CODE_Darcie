model SmeltCo
    uses "mmxprs"


  ! Defining decision variables, index sets and all required notation
  declarations
    number_of_products = 3
    number_of_resources = 4
    products = 1.. number_of_products
    resources = 1.. number_of_resources
    product_names: array(products) of string
    resource_names: array(resources) of string
    max_prod, revenue, upper_limit, lower_limit: array(products) of real
    max_quant, cost: array(resources) of real
    raw_mat: array(resources) of mpvar
    metal_alloys, copper_sum: array(products) of mpvar
  end-declarations

  initialisations from "smeltco_data.dat"
    product_names resource_names max_prod max_quant revenue cost upper_limit lower_limit
  end-initialisations

  ! Objective function is given as the total profit which is defined as the total revenue minus the total costs
  total_profit := sum(p in products) (revenue(p) * metal_alloys(p)) - sum(r in resources)(cost(r) * raw_mat(r))

  ! Set of Constraints:

  ! Capacity and availability constraints
  forall(p in products) do
    product_ctrs(p) := metal_alloys(p) <= max_prod(p)
  end-do

  forall(r in resources) do
    resource_ctrs(r) := raw_mat(r) <= max_quant(r)
  end-do


  ! Proportion, material balance and blending constraints
  forall(p in products) do
  metal_alloys(p) =  0.90 * (copper_sum(p) + raw_mat(p+1))
  upper_limit(p) * copper_sum(p) <= raw_mat(p+1)
  lower_limit(p) * raw_mat(p+1) <= copper_sum(p)
  end-do

  raw_mat(1) = sum(p in products) (copper_sum(p))

  ! Non - negativity constraint
  forall(p in products) do
  metal_alloys(p) >= 0
  end-do

  maximise(total_profit)


  writeln("Revenue for : £", strfmt(100*getsol(sum(p in products)(revenue(p)*metal_alloys(p)))/100,0,2))
  writeln("Cost: £", strfmt(100*getsol(sum(r in resources)(cost(r) * raw_mat(r)))/100,0,2))
  
  writeln('Total profit: £',strfmt(100*getsol(total_profit)/100,0,2))
  writeln('')
  forall(p in products) do writeln('Amount of ', product_names(p),' produced: ', strfmt(getsol(metal_alloys(p)),0,2))
  end-do
  writeln('')
  forall(r in resources) do writeln('Amount of ', resource_names(r),' bought: ', strfmt(getsol(raw_mat(r)),0,2))
  end-do

  
! Sensitivity analysis, constraints

  writeln("")
  forall(r in resources) do
	  if(getslack(resource_ctrs(r))<0.0001) then
	 	   writeln("Dual variable for resource ",resource_names(r), " is £",strfmt(getdual(resource_ctrs(r)),0,2))
		   a := strfmt(getrange(XPRS_LOACT,resource_ctrs(r)),0,2)
		   b := strfmt(getrange(XPRS_UPACT,resource_ctrs(r)),0,2)
		   writeln("The range for the dual for resource ", resource_names(r), " is (",a,",",b,")")
	  end-if
  end-do
  
  ! Sensitivity analysis, production capacity

  writeln("")
  forall(p in products) do
	  if(getslack(product_ctrs(p))<0.0001) then
	 	   writeln("Dual variable for product ",product_names(p), ' is £', strfmt(getdual(product_ctrs(p)),0,2))
		   a := strfmt(getrange(XPRS_LOACT,product_ctrs(p)),0,2)
		   b := strfmt(getrange(XPRS_UPACT,product_ctrs(p)),0,2)
		   writeln("The range for the dual for product ", product_names(p), " is (",a,",",b,")")
	  end-if
  end-do
  
end-model
